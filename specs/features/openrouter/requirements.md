# OpenRouter 简单版本 - 详细需求

## 功能需求

### FR1: 模型路由功能

**描述**：系统能够根据请求中的模型标识符，将请求路由到对应的模型提供商。

**详细要求**：

- 支持模型标识符格式：`{provider}/{model-name}`
- 支持的路由提供商：
  - OpenAI (openai/gpt-4, openai/gpt-3.5-turbo)
  - Anthropic (anthropic/claude-3-opus, anthropic/claude-3-sonnet)
  - Google (google/gemini-pro)
  - OpenRouter (openrouter/gpt-4, openrouter/claude-3-opus 等)
- 如果模型不存在，返回 `model_not_found` 错误
- 路由决策时间 < 100ms

### FR2: 请求转换功能

**描述**：将统一的请求格式转换为目标模型提供商的格式。

**详细要求**：

- 接收标准化的请求格式（OpenAI 兼容格式）
- 根据目标提供商转换请求格式
- 保持消息内容和参数的一致性
- 支持参数映射（temperature, max_tokens, top_p 等）

### FR3: 响应转换功能

**描述**：将模型提供商的响应转换为统一的响应格式。

**详细要求**：

- 统一响应格式（OpenAI 兼容格式）
- 包含完整的响应信息（id, model, choices, usage）
- 处理不同提供商的响应差异
- 正确计算 token 使用量

### FR4: API 接口

**描述**：提供 RESTful API 接口（基于 Python FastAPI 框架）。

**详细要求**：

- `POST /v1/chat/completions`：聊天完成接口
  - 支持普通模式（`stream: false`）
  - 支持流式模式（`stream: true`），使用 Server-Sent Events (SSE)
  - 流式响应格式符合 OpenAI 兼容格式
- `GET /v1/models`：模型列表接口
- 支持 JSON 请求和响应
- 支持 CORS（跨域请求）
- API 版本控制（通过路径前缀）
- 使用 FastAPI 的异步特性提高性能

### FR5: 配置管理

**描述**：管理系统配置和 API Key。

**详细要求**：

- 支持环境变量配置
- 支持配置文件（YAML/JSON）
- API Key 安全存储（不暴露在日志中）
- 支持多个 API Key（每个提供商一个）
- 配置热重载（可选）

### FR6: 错误处理

**描述**：统一的错误处理和响应。

**详细要求**：

- 统一的错误响应格式
- 详细的错误信息（开发环境）
- 安全的错误信息（生产环境）
- 错误日志记录
- HTTP 状态码正确映射

### FR7: 日志记录

**描述**：记录系统运行日志。

**详细要求**：

- 请求日志（请求时间、模型、状态）
- 错误日志（详细错误信息）
- 性能日志（响应时间）
- 日志级别控制（DEBUG, INFO, WARNING, ERROR）
- 日志输出到文件和控制台

### FR8: API Key 管理

**描述**：提供 API Key 的完整生命周期管理功能。

**详细要求**：

- **创建 API Key**：

  - 支持创建新的 API Key
  - 支持设置 API Key 名称和描述
  - 支持设置 API Key 权限（只读、读写、管理员）
  - 支持设置 API Key 过期时间
  - 生成唯一的 API Key 标识符
  - API Key 以加密形式存储

- **查询 API Key**：

  - 支持查询所有 API Key 列表
  - 支持按名称、状态、创建时间等条件筛选
  - 支持分页查询
  - 返回 API Key 基本信息（不返回完整密钥）

- **更新 API Key**：

  - 支持更新 API Key 名称和描述
  - 支持更新 API Key 权限
  - 支持更新 API Key 过期时间
  - 支持启用/禁用 API Key

- **删除 API Key**：

  - 支持删除 API Key
  - 删除前验证权限
  - 支持软删除（标记为已删除，保留历史记录）

- **API Key 验证**：
  - 请求时验证 API Key 有效性
  - 检查 API Key 是否启用
  - 检查 API Key 是否过期
  - 检查 API Key 权限

### FR9: 统计功能

**描述**：提供 API Key 使用统计和查询功能。

**详细要求**：

- **使用统计**：

  - 记录每个 API Key 的请求次数
  - 记录每个 API Key 的 Token 使用量（输入、输出、总计）
  - 记录每个 API Key 的费用（如适用）
  - 记录每个 API Key 的请求时间分布
  - 记录每个 API Key 使用的模型分布

- **统计查询**：

  - 支持按 API Key 查询统计
  - 支持按时间范围查询（日、周、月、自定义）
  - 支持按模型提供商查询统计
  - 支持按模型查询统计
  - 支持聚合统计（总请求数、总 Token 数、总费用等）

- **统计接口**：

  - 提供 RESTful API 接口查询统计
  - 支持实时统计和历史统计
  - 支持导出统计数据（JSON、CSV 格式）
  - 统计响应时间 < 1 秒

- **数据存储**：
  - 统计数据持久化存储（阿里云 RDS）
  - 支持数据清理策略（保留时间可配置）
  - 支持数据备份

### FR10: 组织管理

**描述**：提供组织的完整生命周期管理功能。

**详细要求**：

- **创建组织**：

  - 支持创建新的组织
  - 支持设置组织名称、描述
  - 支持设置组织管理员
  - 生成唯一的组织标识符

- **查询组织**：

  - 支持查询所有组织列表
  - 支持按名称、状态等条件筛选
  - 支持分页查询
  - 支持查询组织详情

- **更新组织**：

  - 支持更新组织名称和描述
  - 支持更新组织状态（启用/禁用）
  - 支持更新组织管理员

- **删除组织**：

  - 支持删除组织
  - 删除前验证权限
  - 支持软删除（标记为已删除，保留历史记录）

- **组织与 API Key 关联**：

  - 支持为组织分配 API Key
  - 支持查看组织下的所有 API Key
  - 支持从组织移除 API Key
  - API Key 必须属于某个组织

- **组织使用限制**：

  - 支持为组织设置 API 使用次数限制（月度/年度）
  - 支持为组织设置 Token 使用量限制
  - 支持为组织设置费用限制
  - 实时检查使用限制，超出限制时拒绝请求

- **组织统计**：
  - 支持查询组织的使用统计
  - 支持按时间范围查询
  - 支持查看组织下所有 API Key 的汇总统计
  - 支持导出统计数据

### FR11: 后台管理界面

**描述**：提供基于 Arco Design Vue 的后台管理界面。

**详细要求**：

- **技术栈**：

  - 前端框架：Vue 3
  - UI 组件库：Arco Design Vue
  - 状态管理：Vuex 或 Pinia
  - 路由：Vue Router
  - HTTP 客户端：Axios

- **功能模块**：

  - 组织管理界面（CRUD 操作）
  - API Key 管理界面（按组织管理）
  - 使用统计可视化（图表展示）
  - 系统配置管理
  - 用户权限管理

- **界面要求**：
  - 响应式设计，支持移动端
  - 现代化的 UI 设计
  - 良好的用户体验
  - 支持国际化（可选）

## 非功能需求

### NFR1: 性能要求

- API 响应时间（不含模型处理）：< 2 秒
- 路由决策时间：< 100ms
- 支持并发请求：至少 10 个并发
- 系统启动时间：< 5 秒

### NFR2: 可靠性要求

- 系统可用性：> 99%
- 错误恢复：自动重试机制（最多 3 次）
- 超时处理：默认 60 秒，可配置
- 优雅降级：模型不可用时返回友好错误

### NFR3: 安全性要求

- API Key 安全存储
- 请求验证和参数校验
- 防止注入攻击
- 日志中不包含敏感信息

### NFR4: 可维护性要求

- 代码模块化设计
- 清晰的代码注释
- 完整的文档
- 易于扩展新的模型提供商

### NFR5: 可部署性要求

- 支持 Docker 容器化
- 支持环境变量配置
- 提供部署文档
- 健康检查接口

## 约束条件

1. **后端技术栈**：

   - Python 3.9+
   - FastAPI 框架
   - 异步编程（async/await）
   - SQLAlchemy ORM（数据库操作）
   - Alembic（数据库迁移）

2. **数据库**：

   - 阿里云 RDS（MySQL 或 PostgreSQL）
   - 使用连接池管理数据库连接
   - 支持读写分离（可选）

3. **前端技术栈**：

   - Vue 3
   - Arco Design Vue
   - Vue Router
   - Vuex/Pinia（状态管理）
   - Axios（HTTP 客户端）

4. **依赖管理**：

   - 后端：requirements.txt
   - 前端：package.json

5. **配置格式**：YAML 或 JSON

6. **日志库**：Python logging 或 structlog

7. **HTTP 客户端**：httpx（异步）或 aiohttp

## 优先级

### P0（必须实现）

- FR1: 模型路由功能（包含 OpenRouter）
- FR2: 请求转换功能
- FR3: 响应转换功能
- FR4: API 接口（聊天完成，包含流式支持）
- FR6: 错误处理
- FR8: API Key 管理（创建、查询、验证）
- FR10: 组织管理（创建、查询、API Key 分配）

### P1（重要）

- FR4: API 接口（模型列表）
- FR5: 配置管理
- FR7: 日志记录
- FR8: API Key 管理（更新、删除）
- FR9: 统计功能（基础统计）
- FR10: 组织管理（更新、删除、使用限制）
- FR11: 后台管理界面（基础功能）

### P2（可选）

- 配置热重载
- 请求缓存
- 监控和指标收集
- FR9: 统计功能（高级统计、导出）
- FR11: 后台管理界面（高级功能、国际化）
