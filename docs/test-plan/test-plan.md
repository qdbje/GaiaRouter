# OpenRouter 测试计划

## 测试概述

本文档描述了OpenRouter项目的测试策略、测试范围、测试方法和测试用例。

## 测试目标

1. 验证所有功能需求是否满足
2. 验证非功能需求是否满足
3. 确保系统稳定性和可靠性
4. 发现和修复缺陷

## 测试范围

### 功能测试

- 模型路由功能
- 请求转换功能
- 响应转换功能
- API接口功能
- 配置管理功能
- 错误处理功能

### 非功能测试

- 性能测试
- 可靠性测试
- 安全性测试
- 兼容性测试

## 测试环境

### 开发环境
- Python 3.9+ / Node.js 18+
- 本地开发服务器
- Mock外部API（用于单元测试）

### 测试环境
- 独立的测试服务器
- 测试用的API Key
- 测试数据

### 生产环境
- 生产服务器
- 生产API Key
- 真实数据

## 测试策略

### 单元测试

**目标**：测试各个模块的功能正确性

**范围**：
- Provider接口实现
- Adapter转换逻辑
- Router路由逻辑
- 配置管理
- 工具函数

**工具**：
- Python: pytest
- Node.js: jest 或 mocha

**覆盖率要求**：> 80%

### 集成测试

**目标**：测试模块之间的集成

**范围**：
- API层与路由层集成
- 路由层与适配器层集成
- 适配器层与提供商层集成
- 端到端流程测试

**工具**：
- Python: pytest + httpx
- Node.js: jest + supertest

### 功能测试

**目标**：验证功能需求

**范围**：
- 聊天完成接口功能
- 模型列表接口功能
- 错误处理功能
- 配置管理功能

### 性能测试

**目标**：验证性能需求

**指标**：
- API响应时间 < 2秒（不含模型处理）
- 路由决策时间 < 100ms
- 支持至少10个并发请求

**工具**：
- Apache Bench (ab)
- wrk
- k6

### 安全测试

**目标**：验证安全性

**范围**：
- API Key安全存储
- 请求参数验证
- 错误信息不泄露敏感信息
- 日志不包含敏感信息

## 测试用例

### TC1: 聊天完成接口 - 成功场景

**测试步骤**：
1. 发送POST请求到 `/v1/chat/completions`
2. 请求体包含有效的模型标识和消息
3. 验证响应状态码为200
4. 验证响应格式正确
5. 验证响应包含完整信息

**预期结果**：
- 状态码：200
- 响应格式符合规范
- 包含id、model、choices、usage字段

### TC2: 聊天完成接口 - 无效模型

**测试步骤**：
1. 发送POST请求到 `/v1/chat/completions`
2. 请求体包含不存在的模型标识
3. 验证响应状态码为404
4. 验证错误信息正确

**预期结果**：
- 状态码：404
- 错误类型：model_not_found
- 错误消息清晰

### TC3: 聊天完成接口 - 无效请求

**测试步骤**：
1. 发送POST请求到 `/v1/chat/completions`
2. 请求体缺少必需字段
3. 验证响应状态码为400
4. 验证错误信息正确

**预期结果**：
- 状态码：400
- 错误类型：invalid_request
- 错误消息指出缺失字段

### TC4: 模型列表接口

**测试步骤**：
1. 发送GET请求到 `/v1/models`
2. 验证响应状态码为200
3. 验证响应包含所有配置的模型
4. 验证每个模型信息完整

**预期结果**：
- 状态码：200
- 返回所有可用模型
- 每个模型包含id、provider等信息

### TC5: OpenAI提供商 - 成功调用

**测试步骤**：
1. 配置有效的OpenAI API Key
2. 发送请求使用openai/gpt-4模型
3. 验证请求成功转发到OpenAI
4. 验证响应正确转换

**预期结果**：
- OpenAI API调用成功
- 响应格式统一
- Token使用量正确

### TC6: Anthropic提供商 - 成功调用

**测试步骤**：
1. 配置有效的Anthropic API Key
2. 发送请求使用anthropic/claude-3-opus模型
3. 验证请求成功转发到Anthropic
4. 验证响应正确转换

**预期结果**：
- Anthropic API调用成功
- 响应格式统一
- Token使用量正确

### TC7: Google提供商 - 成功调用

**测试步骤**：
1. 配置有效的Google API Key
2. 发送请求使用google/gemini-pro模型
3. 验证请求成功转发到Google
4. 验证响应正确转换

**预期结果**：
- Google API调用成功
- 响应格式统一
- Token使用量正确

### TC8: 请求转换 - 参数映射

**测试步骤**：
1. 发送包含temperature、max_tokens等参数的请求
2. 验证参数正确映射到各提供商格式
3. 验证参数值正确传递

**预期结果**：
- 所有参数正确映射
- 参数值正确传递

### TC9: 响应转换 - 格式统一

**测试步骤**：
1. 调用不同提供商的模型
2. 验证所有响应格式统一
3. 验证字段完整性

**预期结果**：
- 所有响应格式统一
- 必需字段都存在

### TC10: 错误处理 - API Key无效

**测试步骤**：
1. 配置无效的API Key
2. 发送请求
3. 验证错误处理正确

**预期结果**：
- 状态码：401
- 错误类型：authentication_error
- 错误消息不泄露API Key

### TC11: 错误处理 - 请求超时

**测试步骤**：
1. 模拟外部API超时
2. 发送请求
3. 验证超时处理正确

**预期结果**：
- 状态码：504
- 错误类型：timeout_error
- 错误消息清晰

### TC12: 错误处理 - 重试机制

**测试步骤**：
1. 模拟外部API临时失败
2. 发送请求
3. 验证重试机制工作
4. 验证最终成功或失败处理

**预期结果**：
- 自动重试最多3次
- 重试间隔合理
- 最终正确处理

### TC13: 性能测试 - 响应时间

**测试步骤**：
1. 发送多个请求
2. 测量API响应时间（不含模型处理）
3. 验证响应时间 < 2秒

**预期结果**：
- 平均响应时间 < 2秒
- 95%请求响应时间 < 2秒

### TC14: 性能测试 - 并发

**测试步骤**：
1. 同时发送10个并发请求
2. 验证所有请求成功处理
3. 验证系统稳定

**预期结果**：
- 所有请求成功处理
- 系统无崩溃
- 响应时间可接受

### TC15: 配置管理 - 环境变量

**测试步骤**：
1. 通过环境变量配置API Key
2. 启动服务
3. 验证配置正确加载

**预期结果**：
- 配置正确加载
- API Key正确使用

### TC16: 配置管理 - 配置文件

**测试步骤**：
1. 通过配置文件配置模型
2. 启动服务
3. 验证配置正确加载

**预期结果**：
- 配置正确加载
- 模型列表正确

### TC17: 日志记录 - 请求日志

**测试步骤**：
1. 发送请求
2. 检查日志文件
3. 验证请求信息记录

**预期结果**：
- 请求信息记录完整
- 不包含敏感信息

### TC18: 日志记录 - 错误日志

**测试步骤**：
1. 触发错误
2. 检查日志文件
3. 验证错误信息记录

**预期结果**：
- 错误信息记录详细
- 包含堆栈信息（开发环境）

## 测试执行计划

### 阶段1：单元测试（第1-2周）
- 执行所有单元测试用例
- 修复发现的缺陷
- 达到覆盖率要求

### 阶段2：集成测试（第2-3周）
- 执行所有集成测试用例
- 修复发现的缺陷
- 验证模块集成

### 阶段3：功能测试（第3周）
- 执行所有功能测试用例
- 修复发现的缺陷
- 验证功能需求

### 阶段4：性能测试（第3-4周）
- 执行性能测试
- 优化性能问题
- 验证性能需求

### 阶段5：安全测试（第4周）
- 执行安全测试
- 修复安全问题
- 验证安全需求

## 缺陷管理

### 缺陷严重程度

- **严重（P0）**：系统崩溃、核心功能不可用
- **重要（P1）**：功能异常、性能问题
- **一般（P2）**：界面问题、提示信息问题
- **轻微（P3）**：建议改进

### 缺陷处理流程

1. 发现缺陷 → 记录缺陷
2. 分配缺陷 → 修复缺陷
3. 验证修复 → 关闭缺陷

## 测试报告

测试完成后，应生成测试报告，包括：
- 测试执行情况
- 测试结果统计
- 缺陷统计
- 测试结论

## 测试工具

- **单元测试**：pytest (Python) / jest (Node.js)
- **集成测试**：pytest + httpx (Python) / jest + supertest (Node.js)
- **性能测试**：Apache Bench, wrk, k6
- **代码覆盖率**：coverage.py (Python) / nyc (Node.js)

