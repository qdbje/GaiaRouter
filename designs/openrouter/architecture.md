# OpenRouter 系统架构设计

## 架构概述

OpenRouter 采用分层架构设计，包括 API 层、路由层、适配器层和提供商层。系统设计遵循单一职责原则和开闭原则，便于扩展新的模型提供商。

## 系统架构图

```
┌─────────────────────────────────────────────────┐
│                  Client                          │
└──────────────────┬──────────────────────────────┘
                   │ HTTP/REST
┌──────────────────▼──────────────────────────────┐
│              API Layer                          │
│  ┌──────────────┐  ┌──────────────┐           │
│  │ Chat API     │  │ Models API   │           │
│  └──────┬───────┘  └──────┬───────┘           │
└─────────┼──────────────────┼────────────────────┘
          │                  │
┌─────────▼──────────────────▼────────────────────┐
│            Router Layer                         │
│  ┌──────────────────────────────────────┐     │
│  │        Model Router                   │     │
│  │  - Parse model identifier             │     │
│  │  - Select provider                    │     │
│  └──────────────┬───────────────────────┘     │
└─────────────────┼──────────────────────────────┘
                  │
┌─────────────────▼──────────────────────────────┐
│          Adapter Layer                          │
│  ┌──────────────┐  ┌──────────────┐          │
│  │ Request      │  │ Response     │          │
│  │ Adapter      │  │ Adapter      │          │
│  └──────┬───────┘  └──────┬───────┘          │
└─────────┼──────────────────┼───────────────────┘
          │                  │
┌─────────▼──────────────────▼───────────────────┐
│         Provider Layer                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  │ OpenAI   │  │Anthropic │  │ Google   │  │OpenRouter│
│  │ Provider │  │ Provider │  │ Provider │  │ Provider │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
└───────┼──────────────┼─────────────┼──────────┘
        │              │             │
        └──────────────┴─────────────┘
                   │ HTTP
        ┌──────────▼──────────┐
        │  External APIs       │
        │  (OpenAI, etc.)      │
        └──────────────────────┘
```

## 架构层次说明

### 1. API 层（API Layer）

**职责**：

- 接收 HTTP 请求
- 请求验证和参数校验
- 响应格式化
- 错误处理

**组件**：

- Chat API Controller：处理聊天完成请求（支持流式响应）
- Models API Controller：处理模型列表请求
- API Key Management Controller：处理 API Key 管理请求
- Organization Management Controller：处理组织管理请求
- Stats API Controller：处理统计查询请求
- Middleware：认证、日志、错误处理、流式响应处理

### 2. 路由层（Router Layer）

**职责**：

- 解析模型标识符
- 选择对应的模型提供商
- 管理模型配置

**组件**：

- Model Router：模型路由核心逻辑
- Model Registry：模型注册表

### 3. 适配器层（Adapter Layer）

**职责**：

- 请求格式转换（统一格式 → 提供商格式）
- 响应格式转换（提供商格式 → 统一格式）
- 参数映射

**组件**：

- Request Adapter：请求适配器接口
- Response Adapter：响应适配器接口
- Provider-specific Adapters：各提供商的适配器实现

### 4. 提供商层（Provider Layer）

**职责**：

- 与外部 API 通信
- HTTP 请求管理
- 错误处理和重试

**组件**：

- Provider Interface：提供商接口
- OpenAI Provider：OpenAI 实现
- Anthropic Provider：Anthropic 实现
- Google Provider：Google 实现
- OpenRouter Provider：OpenRouter 实现

## 技术选型

### 后端框架

- **Python FastAPI**（已确定）
  - 高性能异步框架
  - 支持流式响应（Server-Sent Events）
  - 自动生成 API 文档
  - 类型检查和验证

### 数据库

- **阿里云 RDS**（已确定）
  - MySQL 或 PostgreSQL
  - 使用 SQLAlchemy ORM
  - 使用 Alembic 进行数据库迁移
  - 连接池管理

### HTTP 客户端

- **Python**: `httpx`（异步 HTTP 客户端）
  - 支持流式请求和响应
  - 异步性能优化

### 配置管理

- 环境变量
- YAML 配置文件
- 阿里云 RDS 配置

### 日志

- **Python**: `logging` + `structlog`
  - 结构化日志
  - 日志级别控制

### 前端框架

- **Vue 3**（已确定）
- **Arco Design Vue**（已确定）
  - 企业级 UI 组件库
  - 完整的组件生态
- **Vue Router**：路由管理
- **Vuex/Pinia**：状态管理
- **Axios**：HTTP 客户端

## 数据流

### 请求流程

1. **客户端请求** → API 层接收 HTTP 请求
2. **请求验证** → API 层验证请求格式和参数
3. **路由选择** → 路由层解析模型标识符，选择提供商
4. **请求转换** → 适配器层将请求转换为提供商格式
5. **API 调用** → 提供商层调用外部 API
6. **响应转换** → 适配器层将响应转换为统一格式
7. **返回响应** → API 层返回 HTTP 响应

### 错误处理流程

1. **错误捕获** → 各层捕获异常
2. **错误转换** → 转换为统一错误格式
3. **错误记录** → 记录错误日志
4. **错误响应** → 返回错误响应给客户端

## 扩展性设计

### 添加新提供商

1. 实现 `Provider` 接口
2. 实现 `RequestAdapter` 和 `ResponseAdapter`
3. 在 `ModelRegistry` 中注册新模型
4. 更新配置文件

### 添加新功能

1. 在 API 层添加新的 Controller
2. 在路由层添加新的路由逻辑
3. 更新适配器层（如需要）

## 安全性设计

1. **API Key 管理**：
   - 用户 API Key：数据库存储，加密保存
   - 提供商 API Key：环境变量存储，不在代码中硬编码
   - API Key 验证：请求时验证用户 API Key 有效性
2. **请求验证**：严格验证请求参数和 API Key 权限
3. **错误信息**：生产环境不暴露敏感信息
4. **日志安全**：日志中不包含 API Key 等敏感信息
5. **权限控制**：基于 API Key 权限进行访问控制

## 性能优化

1. **连接池**：HTTP 客户端使用连接池
2. **异步处理**：使用异步框架提高并发性能
3. **缓存**：模型列表可以缓存（可选）
4. **超时控制**：设置合理的请求超时时间
